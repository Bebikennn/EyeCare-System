<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Analytics - EyeCare Admin</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/responsive.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header"><h2>EyeCare</h2><p>Admin Dashboard</p></div>
        <ul class="sidebar-menu">
            <li><a href="/dashboard"><i class="material-icons">dashboard</i> Dashboard</a></li>
            <li><a href="/users"><i class="material-icons">people</i> Users</a></li>
            <li><a href="/assessments"><i class="material-icons">assignment</i> Assessments</a></li>
            <li><a href="/ml-analytics" class="active"><i class="material-icons">analytics</i> ML Analytics</a></li>
            <li><a href="/healthtips"><i class="material-icons">health_and_safety</i> Health Tips</a></li>
            <li><a href="/admin"><i class="material-icons">admin_panel_settings</i> Admin Accounts</a></li>
            <li><a href="/approvals"><i class="material-icons">verified</i> Approvals</a></li>
            <li style="display: none;"><a href="/my-requests"><i class="material-icons">pending_actions</i> My Requests</a></li>
            <li><a href="/settings"><i class="material-icons">settings</i> Settings</a></li>
            <li><a href="/logs"><i class="material-icons">history</i> Activity Logs</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="top-navbar">
            <div class="navbar-left">
                <button class="menu-toggle" onclick="toggleSidebar()"><i class="material-icons">menu</i></button>
            </div>
            <div class="navbar-right">
                {% include 'partials/notification_bell.html' %}
                {% include 'partials/user_menu.html' %}
            </div>
        </div>

        <div class="content-area">
            <div class="page-header">
                <h1>Machine Learning Analytics</h1>
                <p>LightGBM model performance metrics and insights</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue"><i class="material-icons">precision_manufacturing</i></div>
                    <div class="stat-info"><h3 id="accuracy">0%</h3><p>Accuracy</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple"><i class="material-icons">analytics</i></div>
                    <div class="stat-info"><h3 id="precision">0%</h3><p>Precision</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon teal"><i class="material-icons">memory</i></div>
                    <div class="stat-info"><h3 id="recall">0%</h3><p>Recall</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green"><i class="material-icons">functions</i></div>
                    <div class="stat-info"><h3 id="f1score">0%</h3><p>F1 Score</p></div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="card">
                    <div class="card-header"><h3>Feature Importance</h3></div>
                    <div class="card-body"><canvas id="featureChart" height="400"></canvas></div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Confusion Matrix</h3></div>
                    <div class="card-body"><div id="confusionMatrix"></div></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Model Management</h3>
                    <button class="btn btn-warning" onclick="openModal('retrainModal')">
                        <i class="material-icons">model_training</i> Retrain Model
                    </button>
                </div>
                <div class="card-body">
                    <p><strong>Current Model:</strong> <span id="modelVersion">Loading...</span></p>
                    <p><strong>Training Date:</strong> <span id="trainingDate">Loading...</span></p>
                    <p><strong>Dataset Size:</strong> <span id="datasetSize">Loading...</span> samples</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Retrain Modal -->
    <div id="retrainModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2>Retrain LightGBM Model</h2>
                <button class="modal-close" onclick="closeModal('retrainModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Upload Dataset (CSV)</label>
                    <input type="file" id="datasetFile" class="form-control" accept=".csv">
                </div>
                <div class="alert alert-info">
                    <i class="material-icons">info</i>
                    <span>Model retraining may take several minutes. The system will use the uploaded dataset.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('retrainModal')">Cancel</button>
                <button class="btn btn-warning" onclick="retrainModel()">Start Retraining</button>
            </div>
        </div>
    </div>

    <script src="/static/js/utils.js"></script>
    <script src="/static/js/charts.js"></script>
    <script>
        let metricsData = {};

        async function loadMetrics() {
            try {
                const data = await apiRequest('/ml/metrics');
                metricsData = data.metrics;
                
                console.log('Metrics data:', metricsData);
                
                document.getElementById('accuracy').textContent = (metricsData.accuracy * 100).toFixed(2) + '%';
                document.getElementById('precision').textContent = (metricsData.precision * 100).toFixed(2) + '%';
                document.getElementById('recall').textContent = (metricsData.recall * 100).toFixed(2) + '%';
                document.getElementById('f1score').textContent = (metricsData.f1_score * 100).toFixed(2) + '%';
                document.getElementById('modelVersion').textContent = metricsData.model_version;
                document.getElementById('trainingDate').textContent = formatDate(metricsData.training_date);
                document.getElementById('datasetSize').textContent = metricsData.dataset_size.toLocaleString();

                // Parse feature importance (may already be an object)
                const featureImportance = typeof metricsData.feature_importance === 'string' 
                    ? JSON.parse(metricsData.feature_importance) 
                    : metricsData.feature_importance;
                
                console.log('Feature importance:', featureImportance);
                
                if (featureImportance && Object.keys(featureImportance).length > 0) {
                    initFeatureImportanceChart('featureChart', featureImportance);
                } else {
                    document.getElementById('featureChart').parentElement.innerHTML = '<p class="text-center text-muted">No feature importance data available</p>';
                }

                // Parse confusion matrix (may already be an array)
                const confusionMatrix = typeof metricsData.confusion_matrix === 'string'
                    ? JSON.parse(metricsData.confusion_matrix)
                    : metricsData.confusion_matrix;
                
                console.log('Confusion matrix:', confusionMatrix);
                
                if (confusionMatrix && confusionMatrix.length > 0) {
                    renderConfusionMatrixAdvanced('confusionMatrix', confusionMatrix, metricsData.notes);
                } else {
                    document.getElementById('confusionMatrix').innerHTML = '<p class="text-center text-muted">No confusion matrix data available</p>';
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
                showAlert('Failed to load ML metrics: ' + error.message, 'error');
            }
        }
        
        function renderConfusionMatrixAdvanced(containerId, matrix, notes) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Get class labels from notes if available
            let labels = ['Class 0', 'Class 1', 'Class 2', 'Class 3', 'Class 4', 'Class 5', 'Class 6', 'Class 7', 'Class 8', 'Class 9'];
            
            if (notes && notes.classes) {
                labels = notes.classes;
            }
            
            // Truncate labels for display
            const shortLabels = labels.map(l => {
                if (l.length > 15) return l.substring(0, 12) + '...';
                return l;
            });
            
            let html = '<div style="overflow-x: auto;"><table class="confusion-matrix-table" style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            html += '<thead><tr><th style="padding: 8px; border: 1px solid #ddd; background: #f5f5f5;"></th>';
            
            shortLabels.forEach(label => {
                html += `<th style="padding: 8px; border: 1px solid #ddd; background: #f5f5f5; font-weight: 600;">${label}</th>`;
            });
            html += '</tr></thead><tbody>';

            matrix.forEach((row, i) => {
                html += `<tr><th style="padding: 8px; border: 1px solid #ddd; background: #f5f5f5; font-weight: 600;">${shortLabels[i]}</th>`;
                
                const rowSum = row.reduce((a, b) => a + b, 0);
                
                row.forEach((value, j) => {
                    const isCorrect = i === j;
                    const intensity = rowSum > 0 ? (value / rowSum) : 0;
                    const backgroundColor = isCorrect 
                        ? `rgba(76, 175, 80, ${0.3 + intensity * 0.7})`
                        : value > 0 ? `rgba(244, 67, 54, ${intensity * 0.7})` : '#fff';
                    const color = intensity > 0.5 ? '#fff' : '#000';
                    
                    html += `<td style="padding: 8px; border: 1px solid #ddd; background: ${backgroundColor}; color: ${color}; text-align: center; font-weight: ${isCorrect ? '700' : '400'};">${value}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            
            // Add legend
            html += '<div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">';
            html += '<p style="margin: 0 0 10px 0; font-weight: 600; color: #333;">Legend:</p>';
            html += '<div style="display: flex; gap: 20px; flex-wrap: wrap;">';
            html += '<div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 20px; background: rgba(76, 175, 80, 0.8); border-radius: 4px;"></div><span style="font-size: 13px;">Correct Predictions</span></div>';
            html += '<div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 20px; background: rgba(244, 67, 54, 0.6); border-radius: 4px;"></div><span style="font-size: 13px;">Misclassifications</span></div>';
            html += '<div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 20px; background: #fff; border: 1px solid #ddd; border-radius: 4px;"></div><span style="font-size: 13px;">No Cases</span></div>';
            html += '</div></div>';
            
            container.innerHTML = html;
        }

        async function retrainModel() {
            const fileInput = document.getElementById('datasetFile');
            if (!fileInput.files[0]) {
                showAlert('Please select a dataset file', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/ml/upload-dataset', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');

                const uploadData = await response.json();
                
                showAlert('Dataset uploaded. Starting retraining...', 'info');
                
                const retrainData = await apiRequest('/ml/retrain', {
                    method: 'POST',
                    body: JSON.stringify({ dataset_file: uploadData.filepath || uploadData.filename })
                });

                // For non-super-admin, backend queues the request for approval
                const role = getCurrentRole();
                if (role && role !== 'super_admin') {
                    showAlert('Retraining request submitted for approval.', 'success');
                    closeModal('retrainModal');
                    return;
                }

                showAlert('Model retrained successfully!', 'success');
                closeModal('retrainModal');
                loadMetrics();
            } catch (error) {
                showAlert('Retraining failed: ' + error.message, 'error');
            }
        }

        checkSession().then(() => loadMetrics());
    </script>
    <script src="/static/js/notifications.js"></script>
</body>
</html>
